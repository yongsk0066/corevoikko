# voikko-ffi

C-compatible FFI layer for Voikko. Shared by Python (ctypes), Java (JNA), C# (P/Invoke), and Common Lisp (CFFI) bindings.

## Purpose

This crate exposes `VoikkoHandle` as an opaque C pointer with `extern "C"` functions. It handles the translation between Rust's owned types and C's manual memory management, providing dedicated free functions for every allocated return value.

## Public API

30+ extern "C" functions organized by category:

- **Handle lifecycle**: `voikko_new`, `voikko_free`
- **Spell checking**: `voikko_spell`, `voikko_suggest`
- **Morphological analysis**: `voikko_analyze`, `voikko_free_analyses`
- **Hyphenation**: `voikko_hyphenate`, `voikko_insert_hyphens`
- **Grammar checking**: `voikko_grammar_errors`, `voikko_free_grammar_errors`
- **Tokenization**: `voikko_tokens`, `voikko_free_tokens`
- **Sentence detection**: `voikko_sentences`, `voikko_free_sentences`
- **Option setters** (14 boolean + 3 integer): generated by `bool_setter!` macro
- **Utilities**: `voikko_version`, `voikko_attribute_values`, `voikko_free_str`, `voikko_free_str_array`

## Memory management rules

Every allocated return value has a corresponding free function. Callers must follow these rules:

- `*mut c_char` (single string) -- free with `voikko_free_str()`
- `*mut *mut c_char` (NULL-terminated string array) -- free with `voikko_free_str_array()`
- `VoikkoAnalysisArray` -- free with `voikko_free_analyses()`
- `VoikkoGrammarErrorArray` -- free with `voikko_free_grammar_errors()`
- `VoikkoTokenArray` -- free with `voikko_free_tokens()`
- `VoikkoSentenceArray` -- free with `voikko_free_sentences()`
- `voikko_version()` return -- static, do NOT free
- `voikko_attribute_values()` return -- static (leaked), do NOT free

## Key implementation details

- **`bool_setter!` macro**: generates the 14 boolean option setter functions to reduce boilerplate.
- **`#[repr(C)]` structs**: `VoikkoAnalysis`, `VoikkoAnalysisArray`, `VoikkoGrammarError`, `VoikkoGrammarErrorArray`, `VoikkoToken`, `VoikkoTokenArray`, `VoikkoSentence`, `VoikkoSentenceArray` are all C-layout compatible.
- **NULL-terminated arrays**: string arrays and analysis key/value arrays are NULL-terminated, following C conventions.
- **Error reporting**: `voikko_new` accepts an `error_out` parameter for error messages. Other functions return NULL or zero-count structs on error.

## crate-type

`cdylib` + `staticlib` -- supports both dynamic and static linking.

## Build

```bash
# Build shared library
cargo build --release -p voikko-ffi

# Output location:
#   macOS:   target/release/libvoikko_ffi.dylib
#   Linux:   target/release/libvoikko_ffi.so
#   Windows: target/release/voikko_ffi.dll
```

## C header

The public API is declared in `include/voikko.h` (located at `libvoikko/rust/crates/voikko-ffi/include/voikko.h` if it exists, or see the function signatures in `src/lib.rs`).
